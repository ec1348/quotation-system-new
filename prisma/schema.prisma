generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Supplier {
  id             Int      @id @default(autoincrement())
  name           String
  contact        String?
  email          String?
  phone          String?
  businessNumber String?
  address        String?
  priceHistory   ItemPriceHistory[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Client {
  id             Int      @id @default(autoincrement())
  name           String
  address        String?
  email          String?
  phone          String?
  businessNumber String?
  quotes         Quote[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Item {
  id          Int               @id @default(autoincrement())
  
  // --- è­˜åˆ¥è³‡æ–™ (Identity) ---
  name        String            @default("") // å“å (å¦‚: 400W ä¼ºæœé¦¬é”)
  brand       String            // å“ç‰Œ (å¦‚: Delta)
  model       String            // å‹è™Ÿ (å¦‚: ECMA-C20604RS)
  description String?
  year        Int
  
  // --- éŠ·å”®è¨­å®š ---
  salePrice   Float             @default(0) // é€™æ˜¯ã€Œé è¨­ç‰Œåƒ¹ã€ï¼Œçµ¦æ¥­å‹™åƒè€ƒç”¨ï¼Œå ±åƒ¹æ™‚å¯ä»¥æ”¹
  category    String            // Enum: ItemCategory (é›¶ä»¶åˆ†é¡)
  
  // --- ç³»çµ±ä¿è­· ---
  status      String            @default("ACTIVE") // Enum: ItemStatus (é›¶ä»¶ç‹€æ…‹: ACTIVE=å•Ÿç”¨, ARCHIVED=å°å­˜)
  
  // --- é—œè¯ ---
  // é€™è£¡é€£çµåˆ°ã€Œé€²è²¨æˆæœ¬ç´€éŒ„ã€
  priceHistory ItemPriceHistory[]
  
  // é€™è£¡é€£çµåˆ°ã€ŒBOM è¡¨ã€(å¦‚æœé€™å€‹é›¶ä»¶æ˜¯æŸç”¢å“çš„ææ–™)
  materials    ProductMaterial[]
  
  // ç”¨ä¾†æŸ¥è©¢ã€Œé€™å€‹é›¶ä»¶è¢«è³£éå¹¾æ¬¡ã€(é—œè¯åˆ° QuoteItem)
  quoteItems   QuoteItem[]
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // ğŸ”¥ é—œéµè¨­å®šï¼šé˜²æ­¢é‡è¤‡å»ºç«‹ç›¸åŒçš„ã€Œå“ç‰Œ+å‹è™Ÿã€
  @@unique([brand, model])
  // å»ºç«‹ç´¢å¼•ä»¥åŠ é€Ÿæœå°‹
  @@index([name])
}

model ItemPriceHistory {
  id           Int      @id @default(autoincrement())
  itemId       Int
  item         Item     @relation(fields: [itemId], references: [id])
  date         DateTime
  supplierId   Int
  supplier     Supplier @relation(fields: [supplierId], references: [id])
  
  // --- åƒ¹æ ¼è³‡æ–™ ---
  price        Float    // é€²è²¨æˆæœ¬ (Cost)
  currency     String   @default("TWD")
  
  // ç´€éŒ„é€™æ˜¯ã€ŒçœŸçš„è²·äº†ã€é‚„æ˜¯ã€Œåªæ˜¯å•å•ã€
  type         String   // Enum: PriceType (PURCHASE=å¯¦éš›é€²è²¨, QUOTATION=ä¾›æ‡‰å•†å ±åƒ¹)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Product {
  id          Int               @id @default(autoincrement())
  name        String
  description String?
  materials   ProductMaterial[]
  quoteItems  QuoteItem[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model ProductMaterial {
  id        Int     @id @default(autoincrement())
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  itemId    Int
  item      Item    @relation(fields: [itemId], references: [id])
  quantity  Int
}

model Quote {
  id        Int         @id @default(autoincrement())
  clientId  Int
  client    Client      @relation(fields: [clientId], references: [id])
  date      DateTime    @default(now())
  status    String      @default("DRAFT") // DRAFT, SENT, ACCEPTED
  
  // ç¸½é‡‘é¡ (é€šå¸¸ç”±å¾Œç«¯åŠ ç¸½è¨ˆç®—)
  totalAmount Float     @default(0)
  
  items     QuoteItem[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model QuoteItem {
  id          Int      @id @default(autoincrement())
  quoteId     Int
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  // --- 1. ä¾†æºè¿½è¹¤ (é¸å¡«) ---
  // å¦‚æœé€™ä¸€æ•´çµ„æ˜¯å¾æŸå€‹ Product (å¦‚æ”ªæ‹Œæ©Ÿ) åŒ¯å…¥çš„ï¼Œç´€éŒ„ä¾†æº ID
  sourceProductId   Int?
  product     Product? @relation(fields: [sourceProductId], references: [id])
  
  // å³ä½¿ Item è¢«åˆªé™¤ï¼Œé€™è£¡åªæ˜¯ç•™å€‹é€£çµæ–¹ä¾¿çµ±è¨ˆï¼Œä¸å½±éŸ¿å ±åƒ¹å–®é¡¯ç¤º
  itemId      Int?
  item        Item?    @relation(fields: [itemId], references: [id])
  
  // --- 2. çµæ§‹èˆ‡é¡¯ç¤º (Hierarchy) ---
  // æ”¯æ´ BOM å±•é–‹èˆ‡æ‘ºç–Š
  parentId        Int?
  parent          QuoteItem?  @relation("QuoteItemHierarchy", fields: [parentId], references: [id])
  children        QuoteItem[] @relation("QuoteItemHierarchy")
  
  // æ˜¯å¦ç‚ºå¥—è£æ¨™é¡Œï¼Ÿ (True = å ±åƒ¹å–®åªå°é€™è¡Œç¸½åƒ¹ï¼ŒFalse = å°ç´°é …)
  isBundleHeader  Boolean     @default(false)
  displayOrder    Int         @default(0) // ç”¨æ–¼æ’åº

  // --- 3. å¿«ç…§è³‡æ–™ (Snapshot - é€™æ˜¯å ±åƒ¹å–®çœŸæ­£å°å‡ºä¾†çš„å…§å®¹) ---
  // é€™äº›è³‡æ–™åœ¨å»ºç«‹å ±åƒ¹å–®ç•¶ä¸‹ï¼Œæœƒå¾ Item è¤‡è£½éä¾†
  // é€™æ¨£å°±ç®— Item ä¸»æª”æ”¹åæˆ–æ¼²åƒ¹ï¼Œé€™å¼µèˆŠå ±åƒ¹å–®æ°¸é ä¸æœƒè®Š
  brand       String?
  model       String?
  name        String      // æ¥­å‹™å¯ä»¥æ‰‹å‹•ä¿®æ”¹å“å (ä¾‹å¦‚: åŠ è¨» "å«5ç±³ç·š")
  description String?
  
  // --- 4. åƒ¹æ ¼è¨ˆç®— ---
  quantity    Int
  unitPrice   Float       // è³£çµ¦å®¢æˆ¶çš„å–®åƒ¹ (Selling Price)
  total       Float       // quantity * unitPrice
  
  // ğŸ”¥ éš±è—æ¬„ä½ï¼šæˆæœ¬å¿«ç…§
  // å ±åƒ¹ç•¶ä¸‹ï¼Œç³»çµ±å¾ ItemPriceHistory æŠ“ä¾†çš„æœ€æ–°æˆæœ¬
  // ç”¨é€”ï¼šå¹´åº•è¨ˆç®—ã€Œé€™å¼µå–®å¯¦éš›è³ºäº†å¤šå°‘éŒ¢ (æ¯›åˆ©)ã€
  costBasis   Float?

  type        String   @default("COMPONENT") // COMPONENT, LABOR, EXPENSE
  
  // Soft Delete
  deletedAt   DateTime?
}
